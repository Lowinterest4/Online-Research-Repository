<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>URSM Library</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { font-family: Arial, sans-serif; margin:0; height:100vh; display:flex; flex-direction:column; }
header { background:#004080; padding:10px 20px; color:white; }
header input { width:100%; padding:8px; border:none; border-radius:4px; }

main { flex:1; display:flex; overflow:hidden; }
#sidebar { width:240px; background:#f2f2f2; padding:15px; overflow-y:auto; }
#main-content { flex:1; padding:20px; overflow-y:auto; }

#upload-form-container { margin-bottom:20px; border:1px solid #ccc; border-radius:6px; }
#toggle-upload { width:100%; padding:10px; border:none; background:#004080; color:white; cursor:pointer; font-weight:bold; border-radius:6px 6px 0 0; }
#uploadFormWrapper { display:none; padding:10px; }
#uploadForm input, #uploadForm textarea { width:100%; padding:6px; margin:4px 0; border-radius:4px; border:1px solid #ccc; }
#uploadForm label { font-weight:bold; margin-top:8px; display:block; }
#uploadForm button { background:#004080; color:white; padding:8px 12px; border:none; border-radius:4px; margin-top:8px; cursor:pointer; }

.abstract-page { border-bottom:1px solid #ccc; padding-bottom:10px; margin-bottom:15px; }
.abstract-title { font-size:18px; font-weight:bold; color:#004080; cursor:pointer; }
.abstract-meta { font-size:12px; color:#666; margin-top:2px; }
.abstract-content { display:none; margin-top:8px; }
.meta-grid { display:grid; grid-template-columns:120px 1fr; gap:6px; }

#keyword-buttons, #year-buttons { display:flex; flex-direction:column; gap:6px; }
#keyword-buttons button, #year-buttons button { width:100%; text-align:left; cursor:pointer; }
.edit-btn {margin-top:10px; padding:6px 10px;  border:none;  border-radius:4px;  color:white;  background:#1976d2;  margin-left:5px;  cursor:pointer;}

.delete-btn { margin-top:10px; padding:6px 10px; border:none; border-radius:4px; color:white; background:#d32f2f; margin-left:5px;} 
.editmodal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
.editmodal-body { background:#fff; border-radius:12px; width:95vw; max-width:95vw; height:95vh; max-height:95vh; padding:20px 30px; box-shadow:0 10px 30px rgba(0,0,0,0.25); display:flex; flex-direction:column; gap:15px; font-family:Arial,sans-serif; overflow-y:auto; }
#editForm input, #editForm textarea { width:100%; padding:12px; margin-top:5px; margin-bottom:15px; border:1px solid #ccc; border-radius:6px; font-size:14px; box-sizing:border-box; resize:vertical; }
#editForm .form-actions { display:flex; justify-content:flex-end; gap:12px; margin-top:10px; flex-shrink:0; }
#editForm .form-actions button { padding:10px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; font-size:14px; transition: background 0.2s; }
#editForm .form-actions button.save { background:#1976d2; color:white; }
#editForm .form-actions button.save:hover { background:#125aa0; }
#editForm .form-actions button.cancel { background:#ccc; color:#333; }
#editForm .form-actions button.cancel:hover { background:#aaa; }
.clearbtn {margin-top:10px; background:#888; color:white; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;}

</style>
</head>

<body>
<!-- Edit Modal (hidden by default) -->
<div id="editModal" class="editmodal">
  <div class="editmodal-body">
    <h3>Edit Research</h3>
    <form id="editForm">
      <label>Title</label>
      <input type="text" id="editTitle" required>

      <label>Category</label>
      <input type="text" id="editCategory">

      <label>Authors (comma separated)</label>
      <input type="text" id="editAuthors">

      <label>Course</label>
      <input type="text" id="editCourse">

      <label>Academic Year</label>
      <input type="text" id="editYear">

      <label>Research Date</label>
      <input type="text" id="editDate">

      <label>Abstract</label>
      <textarea id="editAbstract" rows="6"></textarea>

      <label>Keywords (comma separated)</label>
      <input type="text" id="editKeywords">

      <div class="form-actions">
        <button type="submit" class="save">Save</button>
        <button type="button" id="cancelEdit" class="cancel">Cancel</button>
      </div>
    </form>
  </div>
</div>

<header>
  <input id="search" placeholder="Search by title, author, keyword...">
</header>

<main>

<div id="sidebar">
  <h3>Filter by Year</h3>
  <div id="year-buttons"></div>

  <h3>Top Keywords</h3>
  <div id="keyword-buttons"></div>
  <button id="clear-filters" class="clearbtn">Clear Filters</button>

</div>

<div id="main-content">

  <!-- Collapsible Upload Form -->
  <div id="upload-form-container">
    <button id="toggle-upload">Upload Research ▼</button>
    <div id="uploadFormWrapper">
      <form id="uploadForm">
        <label>Title</label>
        <input type="text" id="title" required>

        <label>Category</label>
        <input type="text" id="category" placeholder="e.g., An Undergraduate Thesis....">

        <label>Authors (comma separated)</label>
        <input type="text" placeholder="e.g., Person A, Person B...etc" id="authors">

        <label>Course</label>
        <input type="text" placeholder="e.g., Bachelor of......" id="course">

        <label>Major</label>
        <input type="text" placeholder="e.g., Information Communication Technology" id="major">

        <label>Academic Year</label>
        <input type="text" id="academic_year" placeholder="e.g., 2020-2021">

        <label>Research Date (Month Year)</label>
        <input type="text" id="research_date" placeholder="e.g., July 2021">

        <label>Abstract</label>
        <textarea id="abstract" rows="4"></textarea>

        <label>Keywords (comma separated)</label>
        <input type="text" id="keywords" placeholder="e.g., Key, Words">

        <label>Upload Password</label>
        <input type="password" id="upload_password" placeholder="Enter password" required>

        <button type="submit">Upload</button>
      </form>
    </div>
  </div>

  <!-- Research List -->
  <div id="research-list">Loading…</div>

</div>

</main>

<script>
document.addEventListener("DOMContentLoaded", async () => {

const SUPABASE_URL = "https://emakckalouwopodqehgn.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVtYWtja2Fsb3V3b3BvZHFlaGduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NzA3OTYsImV4cCI6MjA4MTE0Njc5Nn0.eRQMLCrL4xEb58ap8RKTOyJx8pusfbr8Ut037GpYXfk";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const list = document.getElementById("research-list");
const search = document.getElementById("search");
let dataCache = [];
const clearFiltersBtn = document.getElementById("clear-filters");
clearFiltersBtn.onclick = () => {
  // Reset all filters
  filters.text = "";
  filters.year = null;
  filters.keyword = null;
  filters.date = null;

  // Reset search input
  search.value = "";

  // Re-render full data
  applyFilters();
};

/* ---------- HELPERS ---------- */
const filters = {
  text: "",
  year: null,
  keyword: null,
  date: null
};

const toArray = v =>
  Array.isArray(v)
    ? v
    : typeof v === "string"
      ? v.split(/[\n,]/).map(x => x.trim()).filter(Boolean)
      : [];

const firstAuthor = a =>
  Array.isArray(a) && a.length ? a[0] + (a.length>1 ? " et al." : "") : a || "";
  
const toKeywordArray = v => {
  if (!v) return [];
  if (Array.isArray(v)) return v.map(k => k.toString().trim()).filter(Boolean);
  if (typeof v === "string") return v.split(",").map(k => k.trim()).filter(Boolean);
  return [];
};



/* ---------- LOAD ---------- */
async function load() {
  const { data, error } = await supabaseClient
    .from("researches")
    .select("*")
    .order("created_at",{ascending:false});

  if (error) {
    list.textContent = error.message;
    return;
  }

 dataCache = data || [];

/* reset filters */
filters.text = "";
filters.year = null;
filters.keyword = null;
filters.date = null;
search.value = "";

render(dataCache);
renderYears(dataCache);
renderKeywords(dataCache);

}
await load();

/* ---------- RENDER ---------- */
function applyFilters() {
  const q = filters.text.toLowerCase();

  const filtered = dataCache.filter(r => {

    const matchText =
      !q ||
      r.title?.toLowerCase().includes(q) ||
      toArray(r.authors).join(" ").toLowerCase().includes(q) ||
      toKeywordArray(r.keywords).some(k => k.toLowerCase().includes(q)) ||
      r.research_date?.toLowerCase().includes(q);

    const matchYear =
      !filters.year || r.academic_year === filters.year;

    const matchKeyword =
  !filters.keyword ||
  toKeywordArray(r.keywords).some(k =>
    k.toLowerCase().includes(filters.keyword.toLowerCase())
  );



    const matchDate =
      !filters.date || r.research_date === filters.date;

    return matchText && matchYear && matchKeyword && matchDate;
  });

  render(filtered);
}

function render(rows) {
  if (!rows.length) {
    list.textContent = "No research found.";
    return;
  }

  list.innerHTML = rows.map(r=>`
    <div class="abstract-page">
      <div class="abstract-title">
        ${r.title}
        <div class="abstract-meta">${firstAuthor(r.authors)} — ${r.academic_year||"—"}</div>
      </div>

      <div class="abstract-content">
        <div class="meta-grid">
          <div>Authors</div><div>${toArray(r.authors).join("<br>")}</div>
          <div>Course</div><div>${toArray(r.course).join("<br>")}</div>
          <div>Category</div><div>${r.category||""}</div>
          <div>Date</div><div>${r.research_date||""}</div>
          <div>Keywords</div><div>${toKeywordArray(r.keywords).join(", ")}</div>
        </div>

        <p><strong>EXECUTIVE SUMMARY</strong><br>${r.abstract||""}</p>

        <button class="delete-btn" onclick="del(${JSON.stringify(r.id)})">Delete</button>
		<button class="edit-btn" onclick="editResearch(${JSON.stringify(r.id)})">Edit</button>
      </div>
    </div>
  `).join("");

  document.querySelectorAll(".abstract-title").forEach(t=>{
    t.onclick=()=>t.nextElementSibling.style.display =
      t.nextElementSibling.style.display==="block"?"none":"block";
  });
}

/* ---------- SEARCH ---------- */
search.oninput = () => {
  filters.text = search.value;
  applyFilters();
};


/* ---------- FILTERS ---------- */
function renderYears(data){
  const years = [...new Set(data.map(d => d.academic_year).filter(Boolean))];
  const container = document.getElementById("year-buttons");

  container.innerHTML = "";

  years.forEach(year => {
    const btn = document.createElement("button");
    btn.textContent = year;
   btn.onclick = () => {
  filters.year = filters.year === year ? null : year;
  applyFilters();
};

    container.appendChild(btn);
  });
}

function renderKeywords(data) {
  const m = {};

  data.forEach(d => {
    toKeywordArray(d.keywords).forEach(k => {
      m[k] = (m[k] || 0) + 1;
    });
  });

  const container = document.getElementById("keyword-buttons");
  container.innerHTML = "";

  Object.entries(m)
    .sort((a, b) => b[1] - a[1]) // most used first
    .slice(0, 10)
    .forEach(([k]) => {
      const btn = document.createElement("button");
      btn.textContent = k;
      btn.addEventListener("click", () => {
        filters.keyword = filters.keyword === k ? null : k;
        applyFilters();
      });
      container.appendChild(btn);
    });
}



/* ---------- COLLAPSIBLE FORM ---------- */
const toggleBtn = document.getElementById("toggle-upload");
const formWrapper = document.getElementById("uploadFormWrapper");

toggleBtn.onclick = () => {
  const visible = formWrapper.style.display === "block";
  formWrapper.style.display = visible ? "none" : "block";
  toggleBtn.textContent = visible ? "Upload Research ▼" : "Upload Research ▲";
};

/* ---------- PASSWORD PROTECTION ---------- */
const UPLOAD_PASSWORD = "YourSecret123"; // same password for upload & delete
const uploadForm = document.getElementById("uploadForm");

uploadForm.onsubmit = async e =>{
  e.preventDefault();

  const password = document.getElementById("upload_password").value.trim();
  if(password !== UPLOAD_PASSWORD){
    alert("Incorrect password! Upload denied.");
    return;
  }

  const title = document.getElementById("title").value.trim();
  const category = document.getElementById("category").value.trim();
  const authors = document.getElementById("authors").value
    .split(",").map(a=>a.trim()).filter(Boolean).join("\n");
  const course = document.getElementById("course").value.trim();
  const major = document.getElementById("major").value.trim();
  const academic_year = document.getElementById("academic_year").value.trim();
  const research_date = document.getElementById("research_date").value.trim();
  const abstract = document.getElementById("abstract").value.trim();
  const keywords = document.getElementById("keywords").value
    .split(",").map(k=>k.trim()).filter(Boolean);

  const combinedCourse = course + (major ? "\nMajor in " + major : "");

  const { data, error } = await supabaseClient.from("researches").insert([{
    title,
    category,
    authors,
    course: combinedCourse,
    academic_year,
    research_date,
    abstract,
    keywords
  }]);

  if (error) alert(error.message);
  else {
    alert("Research uploaded successfully!");
    uploadForm.reset();
    load();
  }
};

/* ---------- DELETE WITH PASSWORD ---------- */
window.del = async id =>{
  const password = prompt("Enter password to delete this research:");
  if(password !== UPLOAD_PASSWORD){
    alert("Incorrect password! Delete denied.");
    return;
  }

  if (!confirm("Delete this research?")) return;

  const { error } = await supabaseClient.from("researches").delete().eq("id",id);
  if (error) alert(error.message);
  else location.reload();
};
/* ---------- EDIT WITH PASSWORD ---------- */
window.editResearch = async id => {
  const password = prompt("Enter password to edit this research:");
  if (password !== UPLOAD_PASSWORD) {
    alert("Incorrect password! Edit denied.");
    return;
  }

  const record = dataCache.find(r => r.id === id);
  if (!record) {
    alert("Record not found.");
    return;
  }

  // Fill modal fields
  document.getElementById("editTitle").value = record.title;
  document.getElementById("editCategory").value = record.category || "";
  document.getElementById("editAuthors").value = toArray(record.authors).join(", ");
  document.getElementById("editCourse").value = toArray(record.course).join(" ");
  document.getElementById("editYear").value = record.academic_year || "";
  document.getElementById("editDate").value = record.research_date || "";
  document.getElementById("editAbstract").value = record.abstract || "";
  document.getElementById("editKeywords").value = (record.keywords || []).join(", ");

  // Show modal
  const modal = document.getElementById("editModal");
  modal.style.display = "flex";

  // Close modal handler
  const closeModal = () => { modal.style.display = "none"; };
  document.getElementById("cancelEdit").onclick = closeModal;
  modal.onclick = e => { if(e.target === modal) closeModal(); } // click outside closes

  // Submit changes
  const form = document.getElementById("editForm");
  form.onsubmit = async e => {
    e.preventDefault();

    const updated = {
      title: document.getElementById("editTitle").value.trim(),
      category: document.getElementById("editCategory").value.trim(),
      authors: document.getElementById("editAuthors").value.split(",").map(a => a.trim()).filter(Boolean).join("\n"),
      course: document.getElementById("editCourse").value.trim(),
      academic_year: document.getElementById("editYear").value.trim(),
      research_date: document.getElementById("editDate").value.trim(),
      abstract: document.getElementById("editAbstract").value.trim(),
      keywords: document.getElementById("editKeywords").value.split(",").map(k => k.trim()).filter(Boolean)
    };

    const { error } = await supabaseClient
      .from("researches")
      .update(updated)
      .eq("id", id);

    if (error) alert(error.message);
    else {
      alert("Research updated successfully!");
      closeModal();
      load();
    }
  };
};


  
});
</script>

</body>
</html>
	
